<% layout("/layouts/boilerplate") %>

    <body>
        <div class="full-card">
            <%if(items.length == 0){%>
                <h3 style="color: red; margin: 12rem 20rem 10rem 40rem;">Card is Empty! </h3>
                <%}else {%>
                    <div class="card-content">

                        <% for (item of items) { %>
                            <div class="card mb-3 position-relative" style="max-width: 950px; max-height: 200px;">
                                <!-- Delete button in top-right corner -->
                                <form method="POST" action="/card/<%= item._id %>/delete?_method=DELETE" style="position: absolute; top: 10px; right: 10px; z-index: 1;">
                                    <button type="submit" style="border: none; background: transparent; cursor: pointer;">
                    <i class="fa-solid fa-xmark" style="color: black; font-size: 1.3rem;"></i>
                </button>
                                </form>

                                <div class="row g-0">
                                    <!-- Image -->
                                    <div class="col-md-4 card-image">
                                        <img src="<%= item.image_url %>" class="img-fluid rounded-start" alt="..." style="max-width: 100%; max-height: 165px; object-fit: cover;">
                                    </div>

                                    <!-- Card body -->
                                    <div class="col-md-8">
                                        <div class="card-body">
                                            <h5 class="card-title">Name -
                                                <%= item.name %>
                                            </h5>
                                            <p class="card-text">Price - â‚¹
                                                <%= item.price %>
                                            </p>
                                            <p class="card-text">Veg -
                                                <%= item.veg %>
                                            </p>
                                            <p class="card-text">Category -
                                                <%= item.category %>
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <% } %>
                    </div>
                    <div class="card-calculation">
                        <div class="card" style="width: 28rem;min-height: 20rem; margin-left: 3rem;color:black;">
                            <div class="card-body">
                                <h4 class="card-title" style="color: red !important;"><b>Total Amount - </b></h4>
                                <h6 class="card-subtitle mb-2 text-body-secondary" style="color:black !important;">Number of items -
                                    <%= totalItems %>
                                </h6>
                                <h6 class="card-subtitle mb-2 text-body-secondary" style="color:black !important;">Price of items -
                                    <%= totalPrice.toFixed(2) %>
                                </h6>
                                <h6 class="card-subtitle mb-2 text-body-secondary" style="color:black !important;">Total Discount(10% ) -
                                    <%= discount.toFixed(2) %>
                                </h6>
                                <h6 class="card-subtitle mb-2 text-body-secondary" style="color:black !important;">Added (18%) GST -
                                    <%= gst.toFixed(2) %>
                                </h6>
                                <hr>
                                <h5 class="card-subtitle mb-2 text-body-secondary" style="color:red  !important;"><b>Total Amount - 
                            <%= finalAmount.toFixed(2) %></b>
                                </h5>
                                <div class="mb-3">
                                    <label for="scheduledAt" class="form-label">Schedule Delivery</label>
                                    <input type="datetime-local" id="scheduledAt" class="form-control" required>
                                </div>

                                <button type="button" id="rzp-cart-btn" class="btn btn-danger" style="margin-bottom: 3rem;">
    Pay & Order All
</button>

                            </div>
                        </div>
                    </div>
                    <%}%>
        </div>
        <!-- Razorpay Script -->
        <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

        <script>
            document.getElementById('rzp-cart-btn').onclick = async function() {
                const scheduledAt = document.getElementById('scheduledAt').value;
                if (!scheduledAt || new Date(scheduledAt) < new Date()) {
                    alert("Please select a valid future date & time for delivery.");
                    return;
                }

                const amount = <%=finalAmount.toFixed(2) %>;

                const res = await fetch("/create-cart-order", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        amount
                    })
                });

                const data = await res.json();

                const options = {
                    key: "<%= process.env.RAZORPAY_KEY_ID || 'rzp_test_123456789' %>",
                    amount: data.amount,
                    currency: "INR",
                    name: "FoodieMe",
                    description: "Cart Order",
                    order_id: data.id,
                    handler: function(response) {
                        alert("Payment ID: " + response.razorpay_payment_id);
                        window.location.href = `/card/order-all-success?scheduledAt=${encodeURIComponent(scheduledAt)}`;
                    },
                    theme: {
                        color: "#F37254"
                    }
                };

                const rzp = new Razorpay(options);
                rzp.open();
            };
        </script>




    </body>