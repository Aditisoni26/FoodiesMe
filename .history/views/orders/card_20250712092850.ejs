<% layout("/layouts/boilerplate") %>

    <body>
        <div class="wrapper d-flex flex-column min-vh-100">
            <div class="container-fluid px-3 px-md-5 mt-4 flex-grow-1">
                <% if (items.length === 0) { %>
                    <h3 class="text-center text-danger my-5">Cart is Empty!</h3>
                    <% } else { %>
                        <div class="row gy-4">
                            <!-- Left: Cart Items -->
                            <div class="col-12 col-md-8">
                                <% for (item of items) { %>
                                    <div class="card mb-3 shadow-sm position-relative">
                                        <!-- Delete button -->
                                        <form method="POST" action="/card/<%= item._id %>/delete?_method=DELETE" class="position-absolute top-0 end-0 mt-2 me-2">
                                            <button type="submit" class="btn btn-sm btn-outline-danger">
                    <i class="fa-solid fa-xmark"></i>
                  </button>
                                        </form>
                                        <div class="row g-0 flex-column flex-md-row">
                                            <!-- Image -->
                                            <div class="col-md-4 text-center">
                                                <img src="<%= item.image_url %>" class="img-fluid rounded-start p-2" style="max-height: 165px; object-fit: cover;" />
                                            </div>
                                            <!-- Details -->
                                            <div class="col-md-8">
                                                <div class="card-body">
                                                    <h5 class="card-title mb-2">Name:
                                                        <%= item.name %>
                                                    </h5>
                                                    <p class="card-text mb-1">Price: ₹
                                                        <%= item.price %>
                                                    </p>
                                                    <p class="card-text mb-1">Veg:
                                                        <%= item.veg %>
                                                    </p>
                                                    <p class="card-text mb-1">Category:
                                                        <%= item.category %>
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <% } %>
                            </div>

                            <!-- Right: Price Summary -->
                            <div class="col-12 col-md-4">
                                <div class="card shadow-sm">
                                    <div class="card-body">
                                        <h4 class="text-danger mb-3"><b>Total Amount</b></h4>
                                        <h6 class="text-secondary">Number of items:
                                            <%= totalItems %>
                                        </h6>
                                        <h6 class="text-secondary">Price of items: ₹
                                            <%= totalPrice.toFixed(2) %>
                                        </h6>
                                        <h6 class="text-secondary">Discount (10%): ₹
                                            <%= discount.toFixed(2) %>
                                        </h6>
                                        <h6 class="text-secondary">GST (18%): ₹
                                            <%= gst.toFixed(2) %>
                                        </h6>
                                        <hr />
                                        <h5 class="text-danger"><b>Final: ₹<%= finalAmount.toFixed(2) %></b></h5>

                                        <!-- Schedule Delivery -->
                                        <div class="mb-3 mt-3">
                                            <label for="scheduledAt" class="form-label">Schedule Delivery</label>
                                            <input type="datetime-local" id="scheduledAt" class="form-control" required />
                                        </div>

                                        <button type="button" id="rzp-cart-btn" class="btn btn-danger w-100">
                  Pay & Order All
                </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <% } %>
            </div>

            <!-- Footer -->
            <footer class="f-info footer bg-light py-3 mt-auto text-center">
                <div class="f-info-links mb-2">
                    <a href="#">About</a> ·
                    <a href="#">Contact</a> ·
                    <a href="#">Help</a>
                </div>
                <div class="f-info-socials mb-2">
                    <i class="fa-brands fa-facebook me-2"></i>
                    <i class="fa-brands fa-twitter me-2"></i>
                    <i class="fa-brands fa-instagram"></i>
                </div>
                <div>&copy; 2025 FoodieMe</div>
            </footer>
        </div>

        <!-- Razorpay Script -->
        <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
        <script>
            document.getElementById('rzp-cart-btn') ? .addEventListener('click', async() => {
                const scheduledAt = document.getElementById('scheduledAt').value;
                if (!scheduledAt || new Date(scheduledAt) < new Date()) {
                    alert("Please select a valid future date & time for delivery.");
                    return;
                }

                const amount = <%= finalAmount.toFixed(2) %>;

                const res = await fetch("/create-cart-order", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        amount
                    })
                });

                const data = await res.json();

                const options = {
                    key: "<%= process.env.RAZORPAY_KEY_ID || 'rzp_test_123456789' %>",
                    amount: data.amount,
                    currency: "INR",
                    name: "FoodieMe",
                    description: "Cart Order",
                    order_id: data.id,
                    handler: function(response) {
                        alert("Payment ID: " + response.razorpay_payment_id);
                        window.location.href = `/card/order-all-success?scheduledAt=${encodeURIComponent(scheduledAt)}`;
                    },
                    theme: {
                        color: "#F37254"
                    }
                };

                const rzp = new Razorpay(options);
                rzp.open();
            });
        </script>
    </body>